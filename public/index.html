<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>iPadClaw</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="iPadClaw">
  <link rel="apple-touch-icon" href="icon.png">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, Helvetica, Arial, sans-serif;
      background: #1a1a2e;
      color: #eee;
      height: 100vh;
      display: -webkit-flex;
      display: flex;
      -webkit-flex-direction: column;
      flex-direction: column;
    }
    #header {
      background: #16213e;
      padding: 12px 16px;
      font-size: 18px;
      font-weight: bold;
      color: #e94560;
      border-bottom: 1px solid #0f3460;
    }
    #chat {
      -webkit-flex: 1;
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    .msg {
      margin: 8px 0;
      padding: 10px 14px;
      border-radius: 16px;
      max-width: 85%;
      word-wrap: break-word;
      font-size: 16px;
      line-height: 1.4;
    }
    .msg.user {
      background: #0f3460;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    .msg.bot {
      background: #16213e;
      border: 1px solid #0f3460;
      border-bottom-left-radius: 4px;
    }
    .msg.error { background: #5a1a1a; color: #ff8888; }
    .msg.thinking { color: #888; font-style: italic; }
    #footer {
      background: #16213e;
      border-top: 1px solid #0f3460;
      padding: 10px;
      display: -webkit-flex;
      display: flex;
    }
    #input {
      -webkit-flex: 1;
      flex: 1;
      padding: 12px;
      border-radius: 22px;
      border: 1px solid #0f3460;
      background: #1a1a2e;
      color: #eee;
      font-size: 16px;
      outline: none;
      margin-right: 8px;
    }
    #send {
      padding: 12px 20px;
      border-radius: 22px;
      border: none;
      background: #e94560;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      min-width: 70px;
    }
    #send:active { opacity: 0.7; }
    #send:disabled { background: #555; }
    #audio { display: none; }
    #login {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: #1a1a2e;
      display: -webkit-flex;
      display: flex;
      -webkit-flex-direction: column;
      flex-direction: column;
      -webkit-align-items: center;
      align-items: center;
      -webkit-justify-content: center;
      justify-content: center;
      padding: 20px;
    }
    #login h1 { color: #e94560; font-size: 28px; margin-bottom: 20px; }
    #tokenInput {
      width: 100%;
      max-width: 340px;
      padding: 14px;
      border-radius: 10px;
      border: 1px solid #0f3460;
      background: #16213e;
      color: #eee;
      font-size: 18px;
      margin-bottom: 16px;
    }
    #loginBtn {
      width: 100%;
      max-width: 340px;
      padding: 14px;
      border-radius: 10px;
      border: none;
      background: #e94560;
      color: white;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="login">
  <h1>iPadClaw</h1>
  <input id="tokenInput" type="password" placeholder="Token" autocomplete="off">
  <button id="loginBtn" onclick="doLogin()">Belépés</button>
</div>

<div id="header">iPadClaw <button onclick="logout()" style="float:right;background:none;border:none;color:#e94560;font-size:14px;cursor:pointer;padding:0">Kilépés</button></div>
<div id="chat"></div>
<audio id="audio"></audio>
<div id="footer">
  <input id="input" type="text" placeholder="Írj vagy diktálj..." autocomplete="off">
  <button id="send" onclick="sendMsg()">Küld</button>
</div>

<script>
var TOKEN = '';
var BASE = window.location.origin + window.location.pathname.replace(/\/$/, '').replace(/\/index\.html$/, '');
var chat = document.getElementById('chat');
var input = document.getElementById('input');
var sendBtn = document.getElementById('send');
var audioEl = document.getElementById('audio');
var loginDiv = document.getElementById('login');
var tokenInput = document.getElementById('tokenInput');

// Mentett token betöltése
var savedToken = localStorage.getItem('ipadclaw_token');
if (savedToken) {
  TOKEN = savedToken;
  loginDiv.style.display = 'none';
  addMsg('Csatlakozva. Miben segíthetek?', 'bot');
}

input.addEventListener('keydown', function(e) {
  if (e.keyCode === 13) { sendMsg(); }
});
tokenInput.addEventListener('keydown', function(e) {
  if (e.keyCode === 13) { doLogin(); }
});

function logout() {
  localStorage.removeItem('ipadclaw_token');
  TOKEN = '';
  loginDiv.style.display = '';
  tokenInput.value = '';
  chat.innerHTML = '';
}

function doLogin() {
  var t = tokenInput.value.trim();
  if (!t) return;
  TOKEN = t;
  localStorage.setItem('ipadclaw_token', t);
  loginDiv.style.display = 'none';
  addMsg('Csatlakozva. Miben segíthetek?', 'bot');
}

function addMsg(text, cls) {
  var div = document.createElement('div');
  div.className = 'msg ' + cls;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

function sendMsg() {
  var text = input.value.trim();
  if (!text || sendBtn.disabled) return;

  addMsg(text, 'user');
  input.value = '';
  sendBtn.disabled = true;

  var thinking = addMsg('Gondolkodik...', 'thinking');

  var xhr = new XMLHttpRequest();
  xhr.open('POST', BASE + '/chat', true);
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.setRequestHeader('Authorization', 'Bearer ' + TOKEN);
  xhr.timeout = 120000;

  xhr.onreadystatechange = function() {
    if (xhr.readyState !== 4) return;
    chat.removeChild(thinking);
    sendBtn.disabled = false;

    if (xhr.status === 200) {
      try {
        var res = JSON.parse(xhr.responseText);
        addMsg(res.text || '(üres válasz)', 'bot');
        if (res.mediaUrl) {
          var murl = res.mediaUrl.charAt(0) === '/' ? res.mediaUrl : '/' + res.mediaUrl;
          audioEl.src = BASE + murl;
          audioEl.play();
        }
      } catch (e) {
        addMsg('Parse hiba: ' + e.message, 'error');
      }
    } else if (xhr.status === 401) {
      addMsg('Hibás token! Töltsd újra az oldalt.', 'error');
    } else {
      addMsg('Hiba: HTTP ' + xhr.status, 'error');
    }
  };

  xhr.ontimeout = function() {
    chat.removeChild(thinking);
    sendBtn.disabled = false;
    addMsg('Időtúllépés (2 perc). Próbáld újra.', 'error');
  };

  xhr.send(JSON.stringify({ text: text }));
}
</script>
</body>
</html>
