<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>VomyClaw</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="VomyClaw">
  <link rel="apple-touch-icon" href="icon.png">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, Helvetica, Arial, sans-serif;
      background: #1a1a2e;
      color: #eee;
      height: 100vh;
      display: -webkit-flex;
      display: flex;
      -webkit-flex-direction: column;
      flex-direction: column;
    }
    #header {
      background: #16213e;
      padding: 0 16px;
      border-bottom: 1px solid #0f3460;
      display: -webkit-flex;
      display: flex;
      -webkit-align-items: center;
      align-items: center;
      min-height: 48px;
    }
    .tab-btn {
      background: none;
      border: none;
      color: #888;
      font-size: 15px;
      font-weight: bold;
      padding: 14px 16px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    .tab-btn.active {
      color: #e94560;
      border-bottom: 2px solid #e94560;
    }
    #tab-chat-panel {
      -webkit-flex: 1;
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    #tab-calendar-panel {
      display: none;
      -webkit-flex: 1;
      flex: 1;
      overflow-y: auto;
      background: #1a1a2e;
      padding: 12px;
    }
    .msg {
      margin: 8px 0;
      padding: 10px 14px;
      border-radius: 16px;
      max-width: 85%;
      word-wrap: break-word;
      font-size: 16px;
      line-height: 1.4;
    }
    .msg.user {
      background: #0f3460;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    .msg.bot {
      background: #16213e;
      border: 1px solid #0f3460;
      border-bottom-left-radius: 4px;
    }
    .msg.error { background: #5a1a1a; color: #ff8888; }
    .msg.thinking { color: #888; font-style: italic; }
    #chat-footer {
      background: #16213e;
      border-top: 1px solid #0f3460;
      padding: 10px;
      display: -webkit-flex;
      display: flex;
    }
    #input {
      -webkit-flex: 1;
      flex: 1;
      padding: 12px;
      border-radius: 22px;
      border: 1px solid #0f3460;
      background: #1a1a2e;
      color: #eee;
      font-size: 16px;
      outline: none;
      margin-right: 8px;
    }
    #send {
      padding: 12px 20px;
      border-radius: 22px;
      border: none;
      background: #e94560;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      min-width: 70px;
    }
    #send:active { opacity: 0.7; }
    #send:disabled { background: #555; }
    #audio { display: none; }
    #login {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: #1a1a2e;
      display: -webkit-flex;
      display: flex;
      -webkit-flex-direction: column;
      flex-direction: column;
      -webkit-align-items: center;
      align-items: center;
      -webkit-justify-content: center;
      justify-content: center;
      padding: 20px;
    }
    #login h1 { color: #e94560; font-size: 28px; margin-bottom: 20px; }
    #tokenInput {
      width: 100%;
      max-width: 340px;
      padding: 14px;
      border-radius: 10px;
      border: 1px solid #0f3460;
      background: #16213e;
      color: #eee;
      font-size: 18px;
      margin-bottom: 16px;
    }
    #loginBtn {
      width: 100%;
      max-width: 340px;
      padding: 14px;
      border-radius: 10px;
      border: none;
      background: #e94560;
      color: white;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="login">
  <h1>VomyClaw</h1>
  <input id="tokenInput" type="password" placeholder="Token" autocomplete="off">
  <button id="loginBtn" onclick="doLogin()">Belépés</button>
</div>

<div id="header">
  <button class="tab-btn active" id="tab-chat" onclick="showTab('chat')">Chat</button>
  <button class="tab-btn" id="tab-calendar" onclick="showTab('calendar')">Naptár</button>
  <button onclick="logout()" style="margin-left:auto;background:none;border:none;color:#e94560;font-size:14px;cursor:pointer;padding:4px 8px">Kilépés</button>
</div>

<!-- Chat panel -->
<div id="tab-chat-panel">
  <div id="chat"></div>
</div>

<!-- Calendar panel -->
<div id="tab-calendar-panel">
  <div id="cal-nav" style="display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:space-between;justify-content:space-between;margin-bottom:12px">
    <button id="cal-prev" onclick="calPrev()" style="background:#16213e;border:1px solid #0f3460;color:#eee;padding:8px 14px;border-radius:8px;font-size:18px;cursor:pointer">&#8249;</button>
    <span id="cal-title" style="font-weight:bold;font-size:16px;color:#eee"></span>
    <button id="cal-next" onclick="calNext()" style="background:#16213e;border:1px solid #0f3460;color:#eee;padding:8px 14px;border-radius:8px;font-size:18px;cursor:pointer">&#8250;</button>
  </div>
  <div id="cal-grid"></div>
  <div id="cal-events" style="margin-top:12px"></div>
</div>

<!-- Event detail popup -->
<div id="cal-popup" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:100" onclick="closePopup()">
  <div style="background:#16213e;border:1px solid #0f3460;border-radius:12px;padding:20px;margin:60px 20px;position:relative" onclick="event.stopPropagation()">
    <div id="cal-popup-content"></div>
    <button onclick="closePopup()" style="margin-top:16px;width:100%;padding:12px;background:#e94560;border:none;border-radius:8px;color:white;font-size:16px;cursor:pointer">Bezárás</button>
  </div>
</div>

<audio id="audio"></audio>
<div id="chat-footer" style="background:#16213e;border-top:1px solid #0f3460;padding:10px;display:-webkit-flex;display:flex">
  <input id="input" type="text" placeholder="Írj vagy diktálj..." autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false">
  <button id="send" onclick="sendMsg()">Küld</button>
</div>

<script>
var TOKEN = '';
var BASE = window.location.origin + window.location.pathname.replace(/\/$/, '').replace(/\/index\.html$/, '');
var chat = document.getElementById('chat');
var input = document.getElementById('input');
var sendBtn = document.getElementById('send');
var audioEl = document.getElementById('audio');
var loginDiv = document.getElementById('login');
var tokenInput = document.getElementById('tokenInput');

// Mentett token betöltése
var savedToken = localStorage.getItem('vomyclaw_token');
if (savedToken) {
  TOKEN = savedToken;
  loginDiv.style.display = 'none';
  addMsg('Csatlakozva. Miben segíthetek?', 'bot');
}

input.addEventListener('keydown', function(e) {
  if (e.keyCode === 13) { sendMsg(); }
});
tokenInput.addEventListener('keydown', function(e) {
  if (e.keyCode === 13) { doLogin(); }
});

function logout() {
  localStorage.removeItem('vomyclaw_token');
  TOKEN = '';
  loginDiv.style.display = '';
  tokenInput.value = '';
  chat.innerHTML = '';
}

function doLogin() {
  var t = tokenInput.value.trim();
  if (!t) return;
  TOKEN = t;
  localStorage.setItem('vomyclaw_token', t);
  loginDiv.style.display = 'none';
  addMsg('Csatlakozva. Miben segíthetek?', 'bot');
}

function addMsg(text, cls) {
  var div = document.createElement('div');
  div.className = 'msg ' + cls;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

function sendMsg() {
  var text = input.value.trim();
  if (!text || sendBtn.disabled) return;

  addMsg(text, 'user');
  input.value = '';
  sendBtn.disabled = true;

  var thinking = addMsg('Gondolkodik...', 'thinking');

  var xhr = new XMLHttpRequest();
  xhr.open('POST', BASE + '/chat', true);
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.setRequestHeader('Authorization', 'Bearer ' + TOKEN);
  xhr.timeout = 120000;

  xhr.onreadystatechange = function() {
    if (xhr.readyState !== 4) return;
    chat.removeChild(thinking);
    sendBtn.disabled = false;

    if (xhr.status === 200) {
      try {
        var res = JSON.parse(xhr.responseText);
        addMsg(res.text || '(üres válasz)', 'bot');
        if (res.mediaUrl) {
          var murl = res.mediaUrl.charAt(0) === '/' ? res.mediaUrl : '/' + res.mediaUrl;
          audioEl.src = BASE + murl;
          audioEl.play();
        }
      } catch (e) {
        addMsg('Parse hiba: ' + e.message, 'error');
      }
    } else if (xhr.status === 401) {
      addMsg('Hibás token! Töltsd újra az oldalt.', 'error');
    } else {
      addMsg('Hiba: HTTP ' + xhr.status, 'error');
    }
  };

  xhr.ontimeout = function() {
    chat.removeChild(thinking);
    sendBtn.disabled = false;
    addMsg('Időtúllépés (2 perc). Próbáld újra.', 'error');
  };

  xhr.send(JSON.stringify({ text: text }));
}

function showTab(name) {
  document.getElementById('tab-chat-panel').style.display = name === 'chat' ? '' : 'none';
  document.getElementById('tab-calendar-panel').style.display = name === 'calendar' ? '' : 'none';
  document.getElementById('chat-footer').style.display = name === 'chat' ? '' : 'none';
  document.getElementById('tab-chat').className = 'tab-btn' + (name === 'chat' ? ' active' : '');
  document.getElementById('tab-calendar').className = 'tab-btn' + (name === 'calendar' ? ' active' : '');
  if (name === 'calendar') { loadCalendar(); }
}

// --- CALENDAR ---
var calYear = new Date().getFullYear();
var calMonth = new Date().getMonth() + 1;
var calEvents = [];

var MONTHS = ['Január','Február','Március','Április','Május','Június',
              'Július','Augusztus','Szeptember','Október','November','December'];
var DAYS = ['H','K','Sz','Cs','P','Sz','V'];

function calPrev() {
  calMonth--;
  if (calMonth < 1) { calMonth = 12; calYear--; }
  loadCalendar();
}
function calNext() {
  calMonth++;
  if (calMonth > 12) { calMonth = 1; calYear++; }
  loadCalendar();
}

function loadCalendar() {
  document.getElementById('cal-title').textContent = MONTHS[calMonth-1] + ' ' + calYear;
  var xhr = new XMLHttpRequest();
  xhr.open('GET', BASE + '/api/calendar?year=' + calYear + '&month=' + calMonth, true);
  xhr.setRequestHeader('Authorization', 'Bearer ' + TOKEN);
  xhr.onreadystatechange = function() {
    if (xhr.readyState !== 4) return;
    if (xhr.status === 200) {
      calEvents = JSON.parse(xhr.responseText);
      renderCalendar();
    }
  };
  xhr.send();
}

function renderCalendar() {
  var grid = document.getElementById('cal-grid');
  var firstDay = new Date(calYear, calMonth - 1, 1).getDay();
  firstDay = (firstDay === 0) ? 6 : firstDay - 1;
  var daysInMonth = new Date(calYear, calMonth, 0).getDate();
  var today = new Date();
  var todayStr = today.getFullYear() + '-' +
    String(today.getMonth()+1).padStart(2,'0') + '-' +
    String(today.getDate()).padStart(2,'0');

  var html = '<table style="width:100%;border-collapse:collapse;table-layout:fixed">';
  html += '<tr>';
  for (var d = 0; d < 7; d++) {
    html += '<th style="text-align:center;padding:4px 0;color:#888;font-size:12px;font-weight:normal">' + DAYS[d] + '</th>';
  }
  html += '</tr><tr>';

  var col = 0;
  for (var i = 0; i < firstDay; i++) {
    html += '<td></td>'; col++;
  }

  for (var day = 1; day <= daysInMonth; day++) {
    var dateStr = calYear + '-' + String(calMonth).padStart(2,'0') + '-' + String(day).padStart(2,'0');
    var dayEvents = calEvents.filter(function(e) { return e.date === dateStr; });
    var isToday = dateStr === todayStr;

    var cellStyle = 'text-align:center;padding:2px 0;vertical-align:top;cursor:' + (dayEvents.length ? 'pointer' : 'default');
    var numStyle = 'display:inline-block;width:28px;height:28px;line-height:28px;border-radius:50%;font-size:14px;' +
      (isToday ? 'background:#e94560;color:white;font-weight:bold' : 'color:#eee');

    var dots = '';
    var colors = [];
    dayEvents.forEach(function(e) {
      if (colors.indexOf(e.color) < 0) colors.push(e.color);
    });
    colors.forEach(function(c) {
      dots += '<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:' + c + ';margin:1px"></span>';
    });

    var onclick = dayEvents.length ? 'onclick="showDayEvents(\'' + dateStr + '\')"' : '';
    html += '<td style="' + cellStyle + '" ' + onclick + '>';
    html += '<span style="' + numStyle + '">' + day + '</span>';
    if (dots) html += '<div>' + dots + '</div>';
    html += '</td>';

    col++;
    if (col % 7 === 0 && day < daysInMonth) html += '</tr><tr>';
  }
  while (col % 7 !== 0) { html += '<td></td>'; col++; }
  html += '</tr></table>';
  grid.innerHTML = html;
}

function showDayEvents(dateStr) {
  var dayEvents = calEvents.filter(function(e) { return e.date === dateStr; });
  if (!dayEvents.length) return;
  var parts = dateStr.split('-');
  var label = parts[2] + '. ' + MONTHS[parseInt(parts[1])-1];

  var evList = document.getElementById('cal-events');
  var html = '<div style="font-size:13px;color:#888;margin-bottom:6px">' + label + '</div>';
  dayEvents.forEach(function(e) {
    var evJson = JSON.stringify(e).replace(/"/g, '&quot;');
    html += '<div onclick="showEventDetail(' + evJson + ')" ';
    html += 'style="background:#16213e;border-left:3px solid ' + e.color + ';border-radius:6px;padding:10px 12px;margin-bottom:8px;cursor:pointer">';
    html += '<div style="font-weight:bold;color:#eee;font-size:15px">' + e.title + '</div>';
    if (e.startTime) {
      html += '<div style="color:#888;font-size:13px;margin-top:2px">' + e.startTime;
      if (e.endTime) html += ' - ' + e.endTime;
      html += '</div>';
    } else if (e.allDay) {
      html += '<div style="color:#888;font-size:13px">Egész napos</div>';
    }
    html += '</div>';
  });
  evList.innerHTML = html;
}

function showEventDetail(ev) {
  var src = ev.source === 'calendar' ? 'Általános naptár' : 'Vomitorius naptár';
  var time = '';
  if (ev.startTime) {
    time = ev.startTime;
    if (ev.endTime) time += ' - ' + ev.endTime;
  } else if (ev.allDay) {
    time = 'Egész napos';
  }
  var html = '<div style="color:' + ev.color + ';font-size:12px;margin-bottom:4px">' + src + '</div>';
  html += '<div style="font-size:20px;font-weight:bold;color:#eee;margin-bottom:8px">' + ev.title + '</div>';
  if (time) html += '<div style="color:#aaa;margin-bottom:8px">' + time + '</div>';
  html += '<div style="color:#888;font-size:13px">' + ev.date + '</div>';
  document.getElementById('cal-popup-content').innerHTML = html;
  document.getElementById('cal-popup').style.display = '';
}

function closePopup() {
  document.getElementById('cal-popup').style.display = 'none';
}
</script>
</body>
</html>
